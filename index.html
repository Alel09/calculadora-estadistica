<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Estad√≠stica</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 24px;
            border-radius: 8px 8px 0 0;
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .content {
            padding: 24px;
        }

        .section {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .section h3 {
            font-size: 1.1em;
            color: #2c3e50;
            margin-bottom: 16px;
            font-weight: 600;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #555;
            font-size: 0.9em;
        }

        input[type="number"],
        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: 'Courier New', monospace;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #2c3e50;
        }

        .clase-item {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 12px;
            position: relative;
        }

        .clase-item.disabled {
            opacity: 0.5;
            background: #f9f9f9;
        }

        .clase-item h4 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1em;
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        @media (max-width: 768px) {
            .input-grid {
                grid-template-columns: 1fr;
            }
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-wrapper label {
            margin: 0;
            cursor: pointer;
            user-select: none;
        }

        .btn {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 500;
        }

        .btn:hover {
            background: #34495e;
        }

        .btn-danger {
            background: #e74c3c;
            padding: 6px 12px;
            font-size: 13px;
            position: absolute;
            top: 16px;
            right: 16px;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #7f8c8d;
        }

        .btn-secondary:hover {
            background: #95a5a6;
        }

        .btn-info {
            background: #3498db;
            margin-top: 12px;
        }

        .btn-info:hover {
            background: #2980b9;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .button-group {
                flex-direction: column;
            }
            
            .button-group .btn {
                width: 100%;
            }
        }

        .results {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 24px;
            border-radius: 6px;
            margin-top: 24px;
        }

        .results h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .result-item {
            background: #fafafa;
            padding: 16px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }

        .result-item strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .result-item .value {
            font-size: 1.3em;
            color: #333;
        }

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            margin-top: 16px;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            table {
                font-size: 0.75em;
                min-width: 500px;
            }
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            th, td {
                padding: 8px 6px;
            }
        }

        th {
            background: #2c3e50;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 16px;
            border-radius: 4px;
            margin: 16px 0;
            border-left: 4px solid #c33;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .stats-summary {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background: #fafafa;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }

        .stat-card h4 {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 1.8em;
            font-weight: 600;
            color: #2c3e50;
        }

        .proceso {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            padding: 20px;
            border-radius: 6px;
            margin-top: 16px;
            font-size: 0.9em;
        }

        .proceso h3 {
            color: #2c3e50;
            margin: 20px 0 12px 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 1.1em;
        }

        .proceso h4 {
            color: #34495e;
            margin: 16px 0 8px 0;
            font-size: 1em;
        }

        .proceso p {
            margin: 6px 0;
            color: #333;
        }

        .proceso .formula {
            background: white;
            padding: 12px;
            border-radius: 4px;
            margin: 8px 0;
            border-left: 3px solid #3498db;
            font-family: 'Courier New', monospace;
        }

        .proceso .step {
            margin: 12px 0;
            padding-left: 20px;
        }

        .sesgada {
            color: #27ae60;
            font-weight: 600;
        }

        .insesgada {
            color: #e67e22;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 20px auto;
            padding: 24px;
            border-radius: 8px;
            max-width: 900px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
            padding: 0;
            width: 32px;
            height: 32px;
            line-height: 32px;
        }

        .modal-close:hover {
            color: #333;
        }

        .datos-tabla {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            margin: 12px 0;
        }

        .dato-item {
            background: #f0f0f0;
            padding: 8px;
            text-align: center;
            border-radius: 4px;
            font-weight: 500;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Calculadora Estad√≠stica</h1>
            <p>Cuartiles, Deciles, Percentiles y Desviaci√≥n Est√°ndar para Datos Agrupados</p>
        </div>

        <div class="content">
            <div class="section">
                <h3>Configuraci√≥n General</h3>
                <label for="decimales">N√∫mero de decimales (0-10):</label>
                <input type="number" id="decimales" min="0" max="10" value="2">
            </div>

            <div id="seccionClases">
                <div class="section">
                    <h3>Gesti√≥n de Clases</h3>
                    <button class="btn" onclick="agregarClase()">‚ûï Agregar Clase</button>
                    <div id="inputClases" style="margin-top: 16px;"></div>
                </div>

                <div class="button-group">
                    <button class="btn" onclick="calcularMedia()">Calcular Media</button>
                    <button class="btn" onclick="calcularMediana()">Calcular Mediana</button>
                    <button class="btn" onclick="calcularCuartiles()">Calcular Cuartiles</button>
                    <button class="btn" onclick="calcularDeciles()">Calcular Deciles</button>
                    <button class="btn btn-secondary" onclick="calcularPercentilPersonalizado()">Percentil Personalizado</button>
                    <button class="btn btn-secondary" onclick="calcularDesviacionTabla()">Desviaci√≥n Est√°ndar (Tabla)</button>
                    <button class="btn btn-secondary" onclick="mostrarTabla()">Tabla de Frecuencias</button>
                    <button class="btn btn-secondary" onclick="cambiarADatos()">Cambiar a Datos Simples</button>
                </div>
            </div>

            <div id="seccionDatos" class="hidden">
                <div class="section">
                    <h3>Ingreso de Datos Simples</h3>
                    <label for="datosSimples">Ingresa los datos separados por comas (ej: 12,15,18,20,22):</label>
                    <textarea id="datosSimples" placeholder="12,15,18,20,22,25,28,30"></textarea>
                    <button class="btn" style="margin-top: 12px;" onclick="calcularDesviacionDatos()">Calcular Desviaci√≥n Est√°ndar</button>
                    <button class="btn btn-secondary" style="margin-top: 12px;" onclick="cambiarAClases()">Volver a Clases</button>
                </div>
            </div>

            <div id="resultados"></div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="cerrarModal()">&times;</button>
            <div id="modalContenido"></div>
        </div>
    </div>

    <script>
        let contadorClases = 0;
        let ultimoCalculo = null;

        function cambiarADatos() {
            document.getElementById('seccionClases').classList.add('hidden');
            document.getElementById('seccionDatos').classList.remove('hidden');
            document.getElementById('resultados').innerHTML = '';
        }

        function cambiarAClases() {
            document.getElementById('seccionDatos').classList.add('hidden');
            document.getElementById('seccionClases').classList.remove('hidden');
            document.getElementById('resultados').innerHTML = '';
        }

        function agregarClase() {
            const container = document.getElementById('inputClases');
            const claseDiv = document.createElement('div');
            claseDiv.className = 'clase-item';
            claseDiv.id = `clase-${contadorClases}`;
            claseDiv.innerHTML = `
                <button class="btn btn-danger" onclick="eliminarClase(${contadorClases})">üóëÔ∏è</button>
                <h4>Clase ${contadorClases + 1}</h4>
                <div class="input-grid">
                    <div>
                        <label>Rango (ej: 12-14):</label>
                        <input type="text" id="rango${contadorClases}" placeholder="12-14">
                    </div>
                    <div>
                        <label>Frecuencia:</label>
                        <input type="number" id="freq${contadorClases}" min="0" value="0">
                    </div>
                </div>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="incluir${contadorClases}" checked onchange="toggleClase(${contadorClases})">
                    <label for="incluir${contadorClases}">‚úì Incluir en c√°lculos</label>
                </div>
            `;
            container.appendChild(claseDiv);
            contadorClases++;
        }

        function eliminarClase(id) {
            const elemento = document.getElementById(`clase-${id}`);
            if (elemento) elemento.remove();
        }

        function toggleClase(id) {
            const checkbox = document.getElementById(`incluir${id}`);
            const claseDiv = document.getElementById(`clase-${id}`);
            
            if (checkbox.checked) {
                claseDiv.classList.remove('disabled');
            } else {
                claseDiv.classList.add('disabled');
            }
        }

        function recopilarDatos() {
            const container = document.getElementById('inputClases');
            const clases = container.querySelectorAll('.clase-item');
            const datos = [];

            clases.forEach((clase, index) => {
                const id = clase.id.split('-')[1];
                const checkbox = document.getElementById(`incluir${id}`);
                
                if (checkbox && checkbox.checked) {
                    const rangoInput = document.getElementById(`rango${id}`);
                    const freqInput = document.getElementById(`freq${id}`);
                    
                    if (!rangoInput || !freqInput) return;
                    
                    const rango = rangoInput.value;
                    const freq = parseInt(freqInput.value);

                    if (!rango || isNaN(freq) || freq < 0) {
                        throw new Error(`Datos inv√°lidos en la clase ${index + 1}`);
                    }

                    parsearRango(rango);
                    datos.push({ rango, frecuencia: freq });
                }
            });

            if (datos.length === 0) {
                throw new Error('No hay clases habilitadas para procesar.');
            }

            return datos;
        }

        function parsearRango(rango) {
            const patron = /^(\d+(?:\.\d+)?)-(\d+(?:\.\d+)?)$/;
            const match = rango.trim().match(patron);

            if (!match) {
                throw new Error(`Formato de rango inv√°lido: ${rango}`);
            }

            const inicio = parseFloat(match[1]);
            const fin = parseFloat(match[2]);

            if (inicio >= fin) {
                throw new Error(`El valor inicial debe ser menor que el final: ${rango}`);
            }

            return { inicio, fin };
        }

        function calcularMarcaClase(rango) {
            const { inicio, fin } = parsearRango(rango);
            return (inicio + fin) / 2;
        }

        function calcularMedia() {
            try {
                const datos = recopilarDatos();
                const decimales = parseInt(document.getElementById('decimales').value);
                
                let sumaFM = 0;
                let sumaF = 0;
                const pasos = [];
                
                pasos.push('<h3>C√°lculo de la Media</h3>');
                pasos.push('<div class="formula">Media = Œ£(f √ó m) / Œ£f</div>');
                pasos.push('<h4>Paso 1: Calcular f √ó m para cada clase</h4>');
                
                datos.forEach((dato, i) => {
                    const marca = calcularMarcaClase(dato.rango);
                    const fm = dato.frecuencia * marca;
                    sumaFM += fm;
                    sumaF += dato.frecuencia;
                    
                    pasos.push(`<div class="step"><p>Clase ${i + 1}: ${dato.rango}, f = ${dato.frecuencia}</p>`);
                    pasos.push(`<p>m = (${parsearRango(dato.rango).inicio} + ${parsearRango(dato.rango).fin}) / 2 = ${marca.toFixed(decimales)}</p>`);
                    pasos.push(`<p>f √ó m = ${dato.frecuencia} √ó ${marca.toFixed(decimales)} = ${fm.toFixed(decimales)}</p></div>`);
                });
                
                const media = sumaFM / sumaF;
                
                pasos.push('<h4>Paso 2: Calcular la media</h4>');
                pasos.push(`<div class="step"><p>Œ£(f √ó m) = ${sumaFM.toFixed(decimales)}</p>`);
                pasos.push(`<p>Œ£f = ${sumaF}</p>`);
                pasos.push(`<p><strong>Media = ${sumaFM.toFixed(decimales)} / ${sumaF} = ${media.toFixed(decimales)}</strong></p></div>`);
                
                ultimoCalculo = { tipo: 'media', pasos: pasos };
                
                let html = '<div class="results"><h2>üìä MEDIA</h2>';
                html += '<button class="btn btn-info" onclick="mostrarProceso()">üîç Ver Proceso Detallado</button>';
                html += `<div class="stat-card" style="margin-top: 16px;"><h4>Valor</h4><div class="value">${media.toFixed(decimales)}</div></div>`;
                html += '</div>';
                
                document.getElementById('resultados').innerHTML = html;
            } catch (error) {
                mostrarError(error.message);
            }
        }

        function calcularMediana() {
            try {
                const datos = recopilarDatos();
                const decimales = parseInt(document.getElementById('decimales').value);
                
                const n = datos.reduce((sum, d) => sum + d.frecuencia, 0);
                const posicionMediana = n / 2;
                
                const pasos = [];
                pasos.push('<h3>C√°lculo de la Mediana</h3>');
                pasos.push('<div class="formula">Posici√≥n = n / 2</div>');
                pasos.push(`<div class="step"><p><strong>Paso 1:</strong> n / 2 = ${n} / 2 = ${posicionMediana}</p></div>`);
                
                let acumulado = 0;
                let claseMediana = null;
                let acumuladoAnterior = 0;
                
                for (let i = 0; i < datos.length; i++) {
                    const acumAntes = acumulado;
                    acumulado += datos[i].frecuencia;
                    
                    if (acumulado >= posicionMediana && !claseMediana) {
                        claseMediana = i;
                        acumuladoAnterior = acumAntes;
                        break;
                    }
                }
                
                const dato = datos[claseMediana];
                const { inicio, fin } = parsearRango(dato.rango);
                const frecuenciaClase = dato.frecuencia;
                
                pasos.push(`<h4>Clase de la mediana: ${dato.rango}</h4>`);
                pasos.push(`<div class="step"><p>Frecuencia acumulada anterior = ${acumuladoAnterior}</p></div>`);
                
                const valorPaso2 = posicionMediana - acumuladoAnterior;
                pasos.push(`<div class="step"><p><strong>Paso 2:</strong> ${posicionMediana} - ${acumuladoAnterior} = ${valorPaso2}</p></div>`);
                
                const porcentaje = (valorPaso2 / frecuenciaClase) * 100;
                pasos.push(`<div class="step"><p><strong>Paso 3 (Regla de 3):</strong></p>`);
                pasos.push(`<p>Si ${frecuenciaClase} ‚Üí 100%</p>`);
                pasos.push(`<p>Entonces ${valorPaso2.toFixed(decimales)} ‚Üí x%</p>`);
                pasos.push(`<p>x = (${valorPaso2.toFixed(decimales)} √ó 100) / ${frecuenciaClase} = ${porcentaje.toFixed(decimales)}%</p></div>`);
                
                const amplitud = fin - inicio;
                const y = (porcentaje / 100) * amplitud;
                pasos.push(`<div class="step"><p><strong>Paso 4:</strong> Distancia de la clase = ${fin} - ${inicio} = ${amplitud}</p>`);
                pasos.push(`<p>Si ${amplitud} ‚Üí 100%</p>`);
                pasos.push(`<p>Entonces y ‚Üí ${porcentaje.toFixed(decimales)}%</p>`);
                pasos.push(`<p>y = (${porcentaje.toFixed(decimales)} √ó ${amplitud}) / 100 = ${y.toFixed(decimales)}</p></div>`);
                
                const mediana = inicio + y;
                pasos.push(`<div class="step"><p><strong>Paso 5:</strong> Mediana = ${inicio} + ${y.toFixed(decimales)} = ${mediana.toFixed(decimales)}</p></div>`);
                
                ultimoCalculo = { tipo: 'mediana', pasos: pasos };
                
                let html = '<div class="results"><h2>üìä MEDIANA</h2>';
                html += '<button class="btn btn-info" onclick="mostrarProceso()">üîç Ver Proceso Detallado</button>';
                html += `<div class="stat-card" style="margin-top: 16px;"><h4>Valor</h4><div class="value">${mediana.toFixed(decimales)}</div></div>`;
                html += '</div>';
                
                document.getElementById('resultados').innerHTML = html;
            } catch (error) {
                mostrarError(error.message);
            }
        }

        function calcularCuartiles() {
            try {
                const datos = recopilarDatos();
                const decimales = parseInt(document.getElementById('decimales').value);
                const n = datos.reduce((sum, d) => sum + d.frecuencia, 0);
                
                const cuartiles = [];
                const pasosTodos = [];
                
                for (let q = 1; q <= 4; q++) {
                    const pasos = [];
                    pasos.push(`<h3>C√°lculo del Cuartil ${q}</h3>`);
                    pasos.push('<div class="formula">Paso 1: n / 4</div>');
                    const paso1 = n / 4;
                    pasos.push(`<div class="step"><p>${n} / 4 = ${paso1}</p></div>`);
                    
                    pasos.push(`<div class="formula">Paso 1.5: Resultado √ó ${q}</div>`);
                    const posicion = paso1 * q;
                    pasos.push(`<div class="step"><p>${paso1} √ó ${q} = ${posicion}</p></div>`);
                    
                    let acumulado = 0;
                    let claseEncontrada = null;
                    let acumuladoAnterior = 0;
                    
                    for (let i = 0; i < datos.length; i++) {
                        const acumAntes = acumulado;
                        acumulado += datos[i].frecuencia;
                        
                        if (acumulado >= posicion && !claseEncontrada) {
                            claseEncontrada = i;
                            acumuladoAnterior = acumAntes;
                            break;
                        }
                    }
                    
                    const dato = datos[claseEncontrada];
                    const { inicio, fin } = parsearRango(dato.rango);
                    const frecuenciaClase = dato.frecuencia;
                    
                    pasos.push(`<h4>Clase encontrada: ${dato.rango}</h4>`);
                    
                    const valorPaso2 = posicion - acumuladoAnterior;
                    pasos.push(`<div class="step"><p><strong>Paso 2:</strong> ${posicion} - ${acumuladoAnterior} = ${valorPaso2}</p></div>`);
                    
                    const porcentaje = (valorPaso2 / frecuenciaClase) * 100;
                    pasos.push(`<div class="step"><p><strong>Paso 3:</strong> Regla de 3</p>`);
                    pasos.push(`<p>${frecuenciaClase} ‚Üí 100%, ${valorPaso2.toFixed(decimales)} ‚Üí ${porcentaje.toFixed(decimales)}%</p></div>`);
                    
                    const amplitud = fin - inicio;
                    const y = (porcentaje / 100) * amplitud;
                    pasos.push(`<div class="step"><p><strong>Paso 4:</strong> Amplitud = ${amplitud}</p>`);
                    pasos.push(`<p>y = (${porcentaje.toFixed(decimales)} √ó ${amplitud}) / 100 = ${y.toFixed(decimales)}</p></div>`);
                    
                    const cuartil = inicio + y;
                    pasos.push(`<div class="step"><p><strong>Paso 5:</strong> Q${q} = ${inicio} + ${y.toFixed(decimales)} = ${cuartil.toFixed(decimales)}</p></div>`);
                    
                    cuartiles.push(cuartil.toFixed(decimales));
                    pasosTodos.push(pasos.join(''));
                }
                
                ultimoCalculo = { tipo: 'cuartiles', valores: cuartiles, pasos: pasosTodos };
                
                let html = '<div class="results"><h2>üìà CUARTILES</h2>';
                html += '<button class="btn btn-info" onclick="mostrarProceso()">üîç Ver Proceso Detallado</button>';
                html += '<div class="results-grid">';
                cuartiles.forEach((valor, i) => {
                    html += `<div class="result-item"><strong>Q${i + 1}</strong><div class="value">${valor}</div></div>`;
                });
                html += '</div></div>';
                
                document.getElementById('resultados').innerHTML = html;
            } catch (error) {
                mostrarError(error.message);
            }
        }

        function calcularDeciles() {
            try {
                const datos = recopilarDatos();
                const decimales = parseInt(document.getElementById('decimales').value);
                const n = datos.reduce((sum, d) => sum + d.frecuencia, 0);
                
                const deciles = [];
                const pasosTodos = [];
                
                for (let d = 1; d <= 10; d++) {
                    const pasos = [];
                    pasos.push(`<h3>C√°lculo del Decil ${d}</h3>`);
                    pasos.push('<div class="formula">Paso 1: n / 10</div>');
                    const paso1 = n / 10;
                    pasos.push(`<div class="step"><p>${n} / 10 = ${paso1}</p></div>`);
                    
                    pasos.push(`<div class="formula">Paso 1.5: Resultado √ó ${d}</div>`);
                    const posicion = paso1 * d;
                    pasos.push(`<div class="step"><p>${paso1} √ó ${d} = ${posicion}</p></div>`);
                    
                    let acumulado = 0;
                    let claseEncontrada = null;
                    let acumuladoAnterior = 0;
                    
                    for (let i = 0; i < datos.length; i++) {
                        const acumAntes = acumulado;
                        acumulado += datos[i].frecuencia;
                        
                        if (acumulado >= posicion && !claseEncontrada) {
                            claseEncontrada = i;
                            acumuladoAnterior = acumAntes;
                            break;
                        }
                    }
                    
                    const dato = datos[claseEncontrada];
                    const { inicio, fin } = parsearRango(dato.rango);
                    const frecuenciaClase = dato.frecuencia;
                    
                    pasos.push(`<h4>Clase encontrada: ${dato.rango}</h4>`);
                    
                    const valorPaso2 = posicion - acumuladoAnterior;
                    pasos.push(`<div class="step"><p><strong>Paso 2:</strong> ${posicion} - ${acumuladoAnterior} = ${valorPaso2}</p></div>`);
                    
                    const porcentaje = (valorPaso2 / frecuenciaClase) * 100;
                    pasos.push(`<div class="step"><p><strong>Paso 3:</strong> Regla de 3</p>`);
                    pasos.push(`<p>${frecuenciaClase} ‚Üí 100%, ${valorPaso2.toFixed(decimales)} ‚Üí ${porcentaje.toFixed(decimales)}%</p></div>`);
                    
                    const amplitud = fin - inicio;
                    const y = (porcentaje / 100) * amplitud;
                    pasos.push(`<div class="step"><p><strong>Paso 4:</strong> Amplitud = ${amplitud}</p>`);
                    pasos.push(`<p>y = (${porcentaje.toFixed(decimales)} √ó ${amplitud}) / 100 = ${y.toFixed(decimales)}</p></div>`);
                    
                    const decil = inicio + y;
                    pasos.push(`<div class="step"><p><strong>Paso 5:</strong> D${d} = ${inicio} + ${y.toFixed(decimales)} = ${decil.toFixed(decimales)}</p></div>`);
                    
                    deciles.push(decil.toFixed(decimales));
                    pasosTodos.push(pasos.join(''));
                }
                
                ultimoCalculo = { tipo: 'deciles', valores: deciles, pasos: pasosTodos };
                
                let html = '<div class="results"><h2>üìà DECILES</h2>';
                html += '<button class="btn btn-info" onclick="mostrarProceso()">üîç Ver Proceso Detallado</button>';
                html += '<div class="results-grid">';
                deciles.forEach((valor, i) => {
                    html += `<div class="result-item"><strong>D${i + 1}</strong><div class="value">${valor}</div></div>`;
                });
                html += '</div></div>';
                
                document.getElementById('resultados').innerHTML = html;
            } catch (error) {
                mostrarError(error.message);
            }
        }

        function calcularPercentilPersonalizado() {
            const p = prompt('Ingresa el percentil (0-100):');
            if (p === null) return;

            const percentil = parseFloat(p);
            if (isNaN(percentil) || percentil <= 0 || percentil > 100) {
                mostrarError('El percentil debe estar entre 0 y 100');
                return;
            }

            try {
                const datos = recopilarDatos();
                const decimales = parseInt(document.getElementById('decimales').value);
                const n = datos.reduce((sum, d) => sum + d.frecuencia, 0);
                
                const pasos = [];
                pasos.push(`<h3>C√°lculo del Percentil ${percentil}</h3>`);
                pasos.push('<div class="formula">Paso 1: n / 100</div>');
                const paso1 = n / 100;
                pasos.push(`<div class="step"><p>${n} / 100 = ${paso1}</p></div>`);
                
                pasos.push(`<div class="formula">Paso 1.5: Resultado √ó ${percentil}</div>`);
                const posicion = paso1 * percentil;
                pasos.push(`<div class="step"><p>${paso1} √ó ${percentil} = ${posicion}</p></div>`);
                
                let acumulado = 0;
                let claseEncontrada = null;
                let acumuladoAnterior = 0;
                
                for (let i = 0; i < datos.length; i++) {
                    const acumAntes = acumulado;
                    acumulado += datos[i].frecuencia;
                    
                    if (acumulado >= posicion && !claseEncontrada) {
                        claseEncontrada = i;
                        acumuladoAnterior = acumAntes;
                        break;
                    }
                }
                
                const dato = datos[claseEncontrada];
                const { inicio, fin } = parsearRango(dato.rango);
                const frecuenciaClase = dato.frecuencia;
                
                pasos.push(`<h4>Clase encontrada: ${dato.rango}</h4>`);
                
                const valorPaso2 = posicion - acumuladoAnterior;
                pasos.push(`<div class="step"><p><strong>Paso 2:</strong> ${posicion} - ${acumuladoAnterior} = ${valorPaso2}</p></div>`);
                
                const porcentaje = (valorPaso2 / frecuenciaClase) * 100;
                pasos.push(`<div class="step"><p><strong>Paso 3:</strong> Regla de 3</p>`);
                pasos.push(`<p>${frecuenciaClase} ‚Üí 100%, ${valorPaso2.toFixed(decimales)} ‚Üí ${porcentaje.toFixed(decimales)}%</p></div>`);
                
                const amplitud = fin - inicio;
                const y = (porcentaje / 100) * amplitud;
                pasos.push(`<div class="step"><p><strong>Paso 4:</strong> Amplitud = ${amplitud}</p>`);
                pasos.push(`<p>y = (${porcentaje.toFixed(decimales)} √ó ${amplitud}) / 100 = ${y.toFixed(decimales)}</p></div>`);
                
                const resultado = inicio + y;
                pasos.push(`<div class="step"><p><strong>Paso 5:</strong> P${percentil} = ${inicio} + ${y.toFixed(decimales)} = ${resultado.toFixed(decimales)}</p></div>`);
                
                ultimoCalculo = { tipo: 'percentil', pasos: pasos };
                
                const html = `<div class="results"><h2>üìà PERCENTIL ${percentil}</h2>
                    <button class="btn btn-info" onclick="mostrarProceso()">üîç Ver Proceso Detallado</button>
                    <div class="stat-card" style="margin-top: 16px;"><h4>Valor</h4><div class="value">${resultado.toFixed(decimales)}</div></div></div>`;
                
                document.getElementById('resultados').innerHTML = html;
            } catch (error) {
                mostrarError(error.message);
            }
        }

        function calcularDesviacionTabla() {
            try {
                const datos = recopilarDatos();
                const decimales = parseInt(document.getElementById('decimales').value);
                
                let sumaFM = 0;
                let sumaF = 0;
                let sumaFM2 = 0;
                const pasos = [];
                
                pasos.push('<h3>Desviaci√≥n Est√°ndar con Tabla de Frecuencias</h3>');
                pasos.push('<h4>C√°lculo de la Media</h4>');
                
                datos.forEach((dato, i) => {
                    const marca = calcularMarcaClase(dato.rango);
                    const fm = dato.frecuencia * marca;
                    const m2 = marca * marca;
                    const fm2 = dato.frecuencia * m2;
                    sumaFM += fm;
                    sumaF += dato.frecuencia;
                    sumaFM2 += fm2;
                    
                    pasos.push(`<div class="step"><p>Clase ${i + 1}: ${dato.rango}, f = ${dato.frecuencia}</p>`);
                    pasos.push(`<p>m = ${marca.toFixed(decimales)}, f √ó m = ${fm.toFixed(decimales)}</p>`);
                    pasos.push(`<p>m¬≤ = ${m2.toFixed(decimales)}, f √ó m¬≤ = ${fm2.toFixed(decimales)}</p></div>`);
                });
                
                const media = sumaFM / sumaF;
                pasos.push(`<div class="step"><p><strong>Media = Œ£(f √ó m) / Œ£f = ${sumaFM.toFixed(decimales)} / ${sumaF} = ${media.toFixed(decimales)}</strong></p></div>`);
                
                // Desviaci√≥n Sesgada
                pasos.push('<h3 class="sesgada">DESVIACI√ìN EST√ÅNDAR SESGADA (œÉ)</h3>');
                pasos.push('<div class="formula sesgada">Paso 1: Œ£(f √ó m¬≤) / n</div>');
                const paso1Sesgada = sumaFM2 / sumaF;
                pasos.push(`<div class="step"><p>${sumaFM2.toFixed(decimales)} / ${sumaF} = ${paso1Sesgada.toFixed(decimales)}</p></div>`);
                
                pasos.push('<div class="formula sesgada">Paso 2: Resultado Paso 1 - (media)¬≤</div>');
                const varianzaSesgada = paso1Sesgada - (media * media);
                pasos.push(`<div class="step"><p>${paso1Sesgada.toFixed(decimales)} - ${media.toFixed(decimales)}¬≤ = ${paso1Sesgada.toFixed(decimales)} - ${(media * media).toFixed(decimales)} = ${varianzaSesgada.toFixed(decimales)}</p>`);
                pasos.push(`<p><strong>Varianza Sesgada = ${varianzaSesgada.toFixed(decimales)}</strong></p></div>`);
                
                pasos.push('<div class="formula sesgada">Paso 3: D.E.S = ‚àöVarianza</div>');
                const desviacionSesgada = Math.sqrt(varianzaSesgada);
                pasos.push(`<div class="step"><p><strong class="sesgada">D.E. Sesgada (œÉ) = ‚àö${varianzaSesgada.toFixed(decimales)} = ${desviacionSesgada.toFixed(decimales)}</strong></p></div>`);
                
                // Desviaci√≥n Insesgada
                pasos.push('<h3 class="insesgada">DESVIACI√ìN EST√ÅNDAR INSESGADA (s)</h3>');
                pasos.push('<div class="formula insesgada">Paso 1: Œ£(f √ó m¬≤) / (n - 1)</div>');
                const paso1Insesgada = sumaFM2 / (sumaF - 1);
                pasos.push(`<div class="step"><p>${sumaFM2.toFixed(decimales)} / (${sumaF} - 1) = ${sumaFM2.toFixed(decimales)} / ${sumaF - 1} = ${paso1Insesgada.toFixed(decimales)}</p></div>`);
                
                pasos.push('<div class="formula insesgada">Paso 2: Resultado Paso 1 - (media)¬≤</div>');
                const varianzaInsesgada = paso1Insesgada - (media * media);
                pasos.push(`<div class="step"><p>${paso1Insesgada.toFixed(decimales)} - ${media.toFixed(decimales)}¬≤ = ${paso1Insesgada.toFixed(decimales)} - ${(media * media).toFixed(decimales)} = ${varianzaInsesgada.toFixed(decimales)}</p>`);
                pasos.push(`<p><strong>Varianza Insesgada = ${varianzaInsesgada.toFixed(decimales)}</strong></p></div>`);
                
                pasos.push('<div class="formula insesgada">Paso 3: D.E.I = ‚àöVarianza</div>');
                const desviacionInsesgada = Math.sqrt(varianzaInsesgada);
                pasos.push(`<div class="step"><p><strong class="insesgada">D.E. Insesgada (s) = ‚àö${varianzaInsesgada.toFixed(decimales)} = ${desviacionInsesgada.toFixed(decimales)}</strong></p></div>`);
                
                ultimoCalculo = { tipo: 'desviacionTabla', pasos: pasos };
                
                let html = '<div class="results"><h2>üìä DESVIACI√ìN EST√ÅNDAR (TABLA)</h2>';
                html += '<button class="btn btn-info" onclick="mostrarProceso()">üîç Ver Proceso Detallado</button>';
                html += '<div class="stats-summary">';
                html += `<div class="stat-card"><h4>Media</h4><div class="value">${media.toFixed(decimales)}</div></div>`;
                html += `<div class="stat-card"><h4 class="sesgada">D.E. Sesgada (œÉ)</h4><div class="value sesgada">${desviacionSesgada.toFixed(decimales)}</div></div>`;
                html += `<div class="stat-card"><h4 class="insesgada">D.E. Insesgada (s)</h4><div class="value insesgada">${desviacionInsesgada.toFixed(decimales)}</div></div>`;
                html += `<div class="stat-card"><h4>Varianza Sesgada</h4><div class="value">${varianzaSesgada.toFixed(decimales)}</div></div>`;
                html += `<div class="stat-card"><h4>Varianza Insesgada</h4><div class="value">${varianzaInsesgada.toFixed(decimales)}</div></div>`;
                html += '</div></div>';
                
                document.getElementById('resultados').innerHTML = html;
            } catch (error) {
                mostrarError(error.message);
            }
        }

        function calcularDesviacionDatos() {
            try {
                const input = document.getElementById('datosSimples').value;
                if (!input.trim()) {
                    throw new Error('Debes ingresar datos');
                }
                
                const datosArray = input.split(',').map(d => parseFloat(d.trim())).filter(d => !isNaN(d));
                
                if (datosArray.length === 0) {
                    throw new Error('No se encontraron datos v√°lidos');
                }
                
                const decimales = parseInt(document.getElementById('decimales').value);
                const n = datosArray.length;
                
                const pasos = [];
                
                // Paso 1: Mostrar datos y calcular media
                pasos.push('<h3>Desviaci√≥n Est√°ndar con Datos Simples</h3>');
                pasos.push('<h4>Paso 1: Datos y c√°lculo de la media</h4>');
                pasos.push('<div class="datos-tabla">');
                datosArray.forEach((d, i) => {
                    pasos.push(`<div class="dato-item">${d}</div>`);
                });
                pasos.push('</div>');
                
                const suma = datosArray.reduce((acc, d) => acc + d, 0);
                const media = suma / n;
                pasos.push(`<div class="step"><p>Suma = ${suma.toFixed(decimales)}</p>`);
                pasos.push(`<p><strong>Media = ${suma.toFixed(decimales)} / ${n} = ${media.toFixed(decimales)}</strong></p></div>`);
                
                // Paso 2: Desviaciones
                pasos.push('<h4>Paso 2: Dato - Media = Desviaci√≥n</h4>');
                pasos.push('<div style="overflow-x: auto;"><table><thead><tr><th>Dato</th><th>Media</th><th>Desviaci√≥n</th></tr></thead><tbody>');
                const desviaciones = [];
                datosArray.forEach((d, i) => {
                    const desv = d - media;
                    desviaciones.push(desv);
                    pasos.push(`<tr><td>${d}</td><td>${media.toFixed(decimales)}</td><td>${desv.toFixed(decimales)}</td></tr>`);
                });
                pasos.push('</tbody></table></div>');
                
                // Paso 3: Cuadrados
                pasos.push('<h4>Paso 3: Cuadrado de cada desviaci√≥n</h4>');
                pasos.push('<div style="overflow-x: auto;"><table><thead><tr><th>Desviaci√≥n</th><th>Desviaci√≥n¬≤</th></tr></thead><tbody>');
                const cuadrados = [];
                let sumaCuadrados = 0;
                desviaciones.forEach((desv, i) => {
                    const cuad = desv * desv;
                    cuadrados.push(cuad);
                    sumaCuadrados += cuad;
                    pasos.push(`<tr><td>${desv.toFixed(decimales)}</td><td>${cuad.toFixed(decimales)}</td></tr>`);
                });
                pasos.push(`<tr style="font-weight: bold; background: #f0f0f0;"><td>Œ£</td><td>${sumaCuadrados.toFixed(decimales)}</td></tr>`);
                pasos.push('</tbody></table></div>');
                
                // Paso 4 y 5 Sesgada
                pasos.push('<h3 class="sesgada">DESVIACI√ìN EST√ÅNDAR SESGADA (œÉ)</h3>');
                pasos.push('<div class="formula sesgada">Paso 4: Varianza = Œ£(desviaciones¬≤) / n</div>');
                const varianzaSesgada = sumaCuadrados / n;
                pasos.push(`<div class="step"><p>Varianza = ${sumaCuadrados.toFixed(decimales)} / ${n} = ${varianzaSesgada.toFixed(decimales)}</p></div>`);
                
                pasos.push('<div class="formula sesgada">Paso 5: D.E. = ‚àöVarianza</div>');
                const desviacionSesgada = Math.sqrt(varianzaSesgada);
                pasos.push(`<div class="step"><p><strong class="sesgada">D.E. Sesgada (œÉ) = ‚àö${varianzaSesgada.toFixed(decimales)} = ${desviacionSesgada.toFixed(decimales)}</strong></p></div>`);
                
                // Paso 4 y 5 Insesgada
                pasos.push('<h3 class="insesgada">DESVIACI√ìN EST√ÅNDAR INSESGADA (s)</h3>');
                pasos.push('<div class="formula insesgada">Paso 4: Varianza = Œ£(desviaciones¬≤) / (n - 1)</div>');
                const varianzaInsesgada = sumaCuadrados / (n - 1);
                pasos.push(`<div class="step"><p>Varianza = ${sumaCuadrados.toFixed(decimales)} / (${n} - 1) = ${sumaCuadrados.toFixed(decimales)} / ${n - 1} = ${varianzaInsesgada.toFixed(decimales)}</p></div>`);
                
                pasos.push('<div class="formula insesgada">Paso 5: D.E. = ‚àöVarianza</div>');
                const desviacionInsesgada = Math.sqrt(varianzaInsesgada);
                pasos.push(`<div class="step"><p><strong class="insesgada">D.E. Insesgada (s) = ‚àö${varianzaInsesgada.toFixed(decimales)} = ${desviacionInsesgada.toFixed(decimales)}</strong></p></div>`);
                
                ultimoCalculo = { tipo: 'desviacionDatos', pasos: pasos };
                
                let html = '<div class="results"><h2>üìä DESVIACI√ìN EST√ÅNDAR (DATOS)</h2>';
                html += '<button class="btn btn-info" onclick="mostrarProceso()">üîç Ver Proceso Detallado</button>';
                html += '<div class="stats-summary">';
                html += `<div class="stat-card"><h4>n (Datos)</h4><div class="value">${n}</div></div>`;
                html += `<div class="stat-card"><h4>Media</h4><div class="value">${media.toFixed(decimales)}</div></div>`;
                html += `<div class="stat-card"><h4 class="sesgada">D.E. Sesgada (œÉ)</h4><div class="value sesgada">${desviacionSesgada.toFixed(decimales)}</div></div>`;
                html += `<div class="stat-card"><h4 class="insesgada">D.E. Insesgada (s)</h4><div class="value insesgada">${desviacionInsesgada.toFixed(decimales)}</div></div>`;
                html += '</div></div>';
                
                document.getElementById('resultados').innerHTML = html;
            } catch (error) {
                mostrarError(error.message);
            }
        }

        function mostrarTabla() {
            const opcion = prompt('¬øQu√© columnas deseas incluir?\n1 - B√°sico (m, f√óm)\n2 - Completo (m, f√óm, m¬≤, f√óm¬≤)\n\nIngresa 1 o 2:');
            
            if (!opcion || (opcion !== '1' && opcion !== '2')) {
                if (opcion !== null) mostrarError('Opci√≥n inv√°lida. Elige 1 o 2.');
                return;
            }

            try {
                const datos = recopilarDatos();
                const decimales = parseInt(document.getElementById('decimales').value);
                const completo = opcion === '2';
                
                const pasos = [];
                pasos.push('<h3>Construcci√≥n de la Tabla de Frecuencias</h3>');
                
                let html = '<div class="results"><h2>üìä TABLA DE FRECUENCIAS</h2>';
                html += '<button class="btn btn-info" onclick="mostrarProceso()">üîç Ver Proceso Detallado</button>';
                html += '<div style="overflow-x: auto;"><table><thead><tr><th>Clase</th><th>Frecuencia (f)</th><th>Frec. Acum.</th><th>Marca (m)</th><th>f √ó m</th>';
                
                if (completo) {
                    html += '<th>m¬≤</th><th>f √ó m¬≤</th>';
                }
                
                html += '</tr></thead><tbody>';
                
                let acumulado = 0;
                let sumaFM = 0;
                let sumaFM2 = 0;
                
                datos.forEach((dato, i) => {
                    acumulado += dato.frecuencia;
                    const marca = calcularMarcaClase(dato.rango);
                    const fm = dato.frecuencia * marca;
                    const m2 = marca * marca;
                    const fm2 = dato.frecuencia * m2;
                    sumaFM += fm;
                    sumaFM2 += fm2;
                    
                    pasos.push(`<div class="step"><p><strong>Clase ${i + 1}:</strong> ${dato.rango}</p>`);
                    pasos.push(`<p>Marca = (${parsearRango(dato.rango).inicio} + ${parsearRango(dato.rango).fin}) / 2 = ${marca.toFixed(decimales)}</p>`);
                    pasos.push(`<p>f √ó m = ${dato.frecuencia} √ó ${marca.toFixed(decimales)} = ${fm.toFixed(decimales)}</p>`);
                    
                    if (completo) {
                        pasos.push(`<p>m¬≤ = ${m2.toFixed(decimales)}</p>`);
                        pasos.push(`<p>f √ó m¬≤ = ${dato.frecuencia} √ó ${m2.toFixed(decimales)} = ${fm2.toFixed(decimales)}</p>`);
                    }
                    pasos.push(`<p>Frecuencia acumulada = ${acumulado}</p></div>`);
                    
                    html += `<tr>
                        <td>${dato.rango}</td>
                        <td>${dato.frecuencia}</td>
                        <td>${acumulado}</td>
                        <td>${marca.toFixed(decimales)}</td>
                        <td>${fm.toFixed(decimales)}</td>`;
                    
                    if (completo) {
                        html += `<td>${m2.toFixed(decimales)}</td>
                        <td>${fm2.toFixed(decimales)}</td>`;
                    }
                    
                    html += '</tr>';
                });
                
                html += `<tr style="font-weight: bold; background: #f0f0f0;">
                    <td>Total</td>
                    <td>${acumulado}</td>
                    <td>‚Äî</td>
                    <td>‚Äî</td>
                    <td>${sumaFM.toFixed(decimales)}</td>`;
                
                if (completo) {
                    html += `<td>‚Äî</td>
                    <td>${sumaFM2.toFixed(decimales)}</td>`;
                }
                
                html += '</tr></tbody></table></div>';
                
                const media = sumaFM / acumulado;
                
                html += '<div class="stats-summary">';
                html += `<div class="stat-card"><h4>n</h4><div class="value">${acumulado}</div></div>`;
                html += `<div class="stat-card"><h4>Media</h4><div class="value">${media.toFixed(decimales)}</div></div>`;
                html += `<div class="stat-card"><h4>Œ£(f √ó m)</h4><div class="value">${sumaFM.toFixed(decimales)}</div></div>`;
                
                if (completo) {
                    html += `<div class="stat-card"><h4>Œ£(f √ó m¬≤)</h4><div class="value">${sumaFM2.toFixed(decimales)}</div></div>`;
                }
                
                html += '</div></div>';
                
                ultimoCalculo = { tipo: 'tabla', pasos: pasos };
                
                document.getElementById('resultados').innerHTML = html;
            } catch (error) {
                mostrarError(error.message);
            }
        }

        function mostrarProceso() {
            if (!ultimoCalculo) {
                alert('No hay c√°lculos disponibles para mostrar.');
                return;
            }

            let contenido = '<h2>üìù Proceso Detallado de C√°lculo</h2><div class="proceso">';

            if (ultimoCalculo.tipo === 'cuartiles') {
                ultimoCalculo.pasos.forEach((paso, i) => {
                    contenido += paso;
                });
            } else if (ultimoCalculo.tipo === 'deciles') {
                ultimoCalculo.pasos.forEach((paso, i) => {
                    contenido += paso;
                });
            } else {
                contenido += ultimoCalculo.pasos.join('');
            }

            contenido += '</div>';

            document.getElementById('modalContenido').innerHTML = contenido;
            document.getElementById('modal').style.display = 'block';
        }

        function cerrarModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function mostrarError(mensaje) {
            document.getElementById('resultados').innerHTML = 
                `<div class="error">‚ùå Error: ${mensaje}</div>`;
        }

        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                cerrarModal();
            }
        }

        window.onload = () => {
            for (let i = 0; i < 5; i++) {
                agregarClase();
            }
        };
    </script>
</body>
</html>